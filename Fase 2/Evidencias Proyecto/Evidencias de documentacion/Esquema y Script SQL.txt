-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.files (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  file_name character varying NOT NULL,
  file_type character varying NOT NULL,
  file_path text NOT NULL,
  file_size bigint,
  uploaded_by uuid,
  uploaded_at timestamp with time zone DEFAULT now(),
  is_public boolean DEFAULT false,
  CONSTRAINT files_pkey PRIMARY KEY (id),
  CONSTRAINT files_uploaded_by_fkey FOREIGN KEY (uploaded_by) REFERENCES public.users(id)
);
CREATE TABLE public.process_history (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  tunnel_id integer,
  fruit character varying NOT NULL,
  min_temp numeric NOT NULL,
  max_temp numeric NOT NULL,
  ideal_min numeric NOT NULL,
  ideal_max numeric NOT NULL,
  started_at timestamp with time zone NOT NULL,
  ended_at timestamp with time zone NOT NULL,
  started_by uuid,
  ended_by uuid,
  measure_plan integer,
  destination character varying,
  origin character varying,
  condition_initial text,
  description text,
  duration_minutes integer,
  created_at timestamp with time zone DEFAULT now(),
  paused_at timestamp with time zone,
  resumed_at timestamp with time zone,
  finalized_at timestamp with time zone,
  CONSTRAINT process_history_pkey PRIMARY KEY (id),
  CONSTRAINT process_history_tunnel_id_fkey FOREIGN KEY (tunnel_id) REFERENCES public.tunnels(id),
  CONSTRAINT process_history_started_by_fkey FOREIGN KEY (started_by) REFERENCES public.users(id),
  CONSTRAINT process_history_ended_by_fkey FOREIGN KEY (ended_by) REFERENCES public.users(id)
);
CREATE TABLE public.processes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  tunnel_id integer,
  status character varying CHECK (status::text = ANY (ARRAY['idle'::character varying, 'running'::character varying, 'paused'::character varying, 'finished'::character varying]::text[])),
  fruit character varying NOT NULL,
  min_temp numeric NOT NULL,
  max_temp numeric NOT NULL,
  ideal_min numeric NOT NULL,
  ideal_max numeric NOT NULL,
  started_at timestamp with time zone,
  ended_at timestamp with time zone,
  started_by uuid,
  ended_by uuid,
  measure_plan integer,
  destination character varying,
  origin character varying,
  condition_initial text,
  description text,
  state_label character varying,
  last_change timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  paused_at timestamp with time zone,
  resumed_at timestamp with time zone,
  finalized_at timestamp with time zone,
  CONSTRAINT processes_pkey PRIMARY KEY (id),
  CONSTRAINT processes_tunnel_id_fkey FOREIGN KEY (tunnel_id) REFERENCES public.tunnels(id),
  CONSTRAINT processes_started_by_fkey FOREIGN KEY (started_by) REFERENCES public.users(id),
  CONSTRAINT processes_ended_by_fkey FOREIGN KEY (ended_by) REFERENCES public.users(id)
);
CREATE TABLE public.readings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  tunnel_id integer,
  process_id uuid,
  ts timestamp with time zone NOT NULL,
  amb_out numeric,
  amb_ret numeric,
  izq_ext_ent numeric,
  izq_int_ent numeric,
  der_int_ent numeric,
  der_ext_ent numeric,
  izq_ext_sal numeric,
  izq_int_sal numeric,
  der_int_sal numeric,
  der_ext_sal numeric,
  fruit character varying,
  min_temp numeric,
  max_temp numeric,
  ideal_min numeric,
  ideal_max numeric,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT readings_pkey PRIMARY KEY (id),
  CONSTRAINT readings_tunnel_id_fkey FOREIGN KEY (tunnel_id) REFERENCES public.tunnels(id),
  CONSTRAINT readings_process_id_fkey FOREIGN KEY (process_id) REFERENCES public.processes(id)
);
CREATE TABLE public.roles (
  id integer NOT NULL DEFAULT nextval('roles_id_seq'::regclass),
  name character varying NOT NULL UNIQUE,
  description text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT roles_pkey PRIMARY KEY (id)
);
CREATE TABLE public.temperature_alerts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  reading_id uuid,
  tunnel_id integer,
  process_id uuid,
  alert_time timestamp with time zone DEFAULT now(),
  alert_type character varying CHECK (alert_type::text = ANY (ARRAY['warning'::character varying, 'alarm'::character varying]::text[])),
  sensor_name character varying NOT NULL,
  alert_value numeric NOT NULL,
  threshold_value numeric NOT NULL,
  acknowledged boolean DEFAULT false,
  acknowledged_by uuid,
  acknowledged_at timestamp with time zone,
  resolved boolean DEFAULT false,
  resolved_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT temperature_alerts_pkey PRIMARY KEY (id),
  CONSTRAINT temperature_alerts_reading_id_fkey FOREIGN KEY (reading_id) REFERENCES public.readings(id),
  CONSTRAINT temperature_alerts_tunnel_id_fkey FOREIGN KEY (tunnel_id) REFERENCES public.tunnels(id),
  CONSTRAINT temperature_alerts_process_id_fkey FOREIGN KEY (process_id) REFERENCES public.processes(id),
  CONSTRAINT temperature_alerts_acknowledged_by_fkey FOREIGN KEY (acknowledged_by) REFERENCES public.users(id)
);
CREATE TABLE public.tunnels (
  id integer NOT NULL DEFAULT nextval('tunnels_id_seq'::regclass),
  name character varying NOT NULL,
  fruit_type character varying,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT tunnels_pkey PRIMARY KEY (id)
);
CREATE TABLE public.user_sessions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  session_token text NOT NULL UNIQUE,
  login_time timestamp with time zone DEFAULT now(),
  logout_time timestamp with time zone,
  ip_address inet,
  device_info jsonb,
  status character varying DEFAULT 'active'::character varying,
  duration_sec integer,
  remarks text,
  CONSTRAINT user_sessions_pkey PRIMARY KEY (id),
  CONSTRAINT user_sessions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.users (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id character varying NOT NULL UNIQUE,
  password_hash text NOT NULL,
  full_name character varying NOT NULL,
  role_id integer,
  email character varying NOT NULL UNIQUE,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  last_login timestamp with time zone,
  last_logout timestamp with time zone,
  CONSTRAINT users_pkey PRIMARY KEY (id),
  CONSTRAINT users_role_id_fkey FOREIGN KEY (role_id) REFERENCES public.roles(id)
);